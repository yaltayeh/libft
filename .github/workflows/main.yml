name: C Build

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compile files and count results
        id: compile
        run: |
          success=0
          failed=0

          for file in ft_calloc.c ft_split.c ft_strlcpy.c ft_substr.c; do
            echo "Compiling $file ..."
            if cc "$file" -c -o "${file%.c}.o"; then
              echo "âœ” Success: $file"
              success=$((success+1))
            else
              echo "âœ– Failed: $file"
              failed=$((failed+1))
            fi
          done

          echo "success=$success" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT

      - name: Comment results on GitHub
        uses: actions/github-script@v7
        with:
          script: |
            const success = Number("${{ steps.compile.outputs.success }}");
            const failed = Number("${{ steps.compile.outputs.failed }}");
            const total = success + failed;

            const body = `
### ðŸ§ª C Build Results
âœ” **Success:** ${success}/${total}  
âœ– **Failed:** ${failed}/${total}
`;

            // If PR â†’ comment on PR
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            } else {
              // Otherwise comment on commit
              github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: body
              });
            }
